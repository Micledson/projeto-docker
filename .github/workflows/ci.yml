name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    name: 'Build and Push'
    runs-on: ${{ matrix.os }}
    outputs:
      docker_tag: ${{ steps.generate_tag.outputs.sha }}

    strategy:
      matrix:
        go-version: [1.23.2]
        os: [ubuntu-latest]

    steps:
      - name: Checkout do código-fonte
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23.2
          
      - name: Verificar versão do Go
        run: go version

      - name: Baixar dependências
        run: go mod tidy

      - name: ls da pasta
        run: ls

      - name: Build da aplicação
        run: go build ./...

      - name: Run Tests
        run: go test ./...

      - name: Gerar Tag
        id: generate_tag
        run: |
          SHA=$(echo $GITHUB_SHA | head -c7)
          echo "sha=$SHA" >> $GITHUB_OUTPUT


      - name: Login no Container Registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build da imagem Docker API
        run: |
          docker build -t mcsl9/projeto-docker-api:${{ steps.generate_tag.outputs.sha }} \
            -f .docker/development/Dockerfile.api .

      - name: Verificar diretórios e arquivos Dockerfile
        run: |
          echo "📂 Listando diretórios no nível raiz"
          ls -l
          
          echo "📂 Listando conteúdo de .docker/"
          ls -l .docker/
          
          echo "📂 Listando conteúdo de .docker/development/"
          ls -l .docker/development/

          echo "🔍 Verificando se os Dockerfiles existem"
          [ -f .docker/development/Dockerfile.api ] && echo "✅ Dockerfile.api encontrado!" || echo "❌ Dockerfile.api NÃO encontrado!"
          [ -f .docker/development/Dockerfile.postgres ] && echo "✅ Dockerfile.postgres encontrado!" || echo "❌ Dockerfile.postgres NÃO encontrado!"

      - name: Build da imagem Docker DATABASE
        run: |
          docker build -t mcsl9/projeto-docker-database:${{ steps.generate_tag.outputs.sha }} \
            -f .docker/development/Dockerfile.postgres .

      - name: Push da imagem Docker API para o DockerHub
        run: docker push mcsl9/projeto-docker-api:${{ steps.generate_tag.outputs.sha }}

      - name: Push da imagem Docker DATABASE para o DockerHub
        run: docker push mcsl9/projeto-docker-database:${{ steps.generate_tag.outputs.sha }}
